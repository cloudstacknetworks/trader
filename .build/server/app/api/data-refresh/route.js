"use strict";(()=>{var e={};e.id=4297,e.ids=[4297],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},23972:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>_,patchFetch:()=>m,requestAsyncStorage:()=>y,routeModule:()=>h,serverHooks:()=>w,staticGenerationAsyncStorage:()=>g});var a={};r.r(a),r.d(a,{GET:()=>l,POST:()=>f,dynamic:()=>p});var s=r(79182),o=r(72007),n=r(56719),i=r(93442),u=r(57978),d=r(11826),c=r(83178);let p="force-dynamic";async function l(){let e=await (0,u.getServerSession)(d.L);if(!e?.user)return i.NextResponse.json({error:"Unauthorized"},{status:401});try{let e=await c._.dataRefreshLog.findMany({orderBy:{startTime:"desc"},take:10}),t=e.find(e=>"RUNNING"===e.status),r=await c._.stockData.count(),a=await c._.stockData.count({where:{hasError:!1}}),s=await c._.stockData.aggregate({_avg:{dataQuality:!0}}),o=await c._.stockData.findFirst({where:{hasError:!1},orderBy:{lastUpdated:"asc"},select:{lastUpdated:!0}}),n=await c._.stockData.findFirst({where:{hasError:!1},orderBy:{lastUpdated:"desc"},select:{lastUpdated:!0}}),u=new Date(Date.now()-1728e5),d=await c._.stockData.count({where:{OR:[{lastUpdated:{lt:u}},{hasError:!0}]}}),p={isRefreshing:!!t,refreshType:t?.refreshType||null,totalStocks:r,stocksWithData:a,averageDataQuality:s._avg.dataQuality||0,oldestUpdate:o?.lastUpdated?.toISOString()||null,newestUpdate:n?.lastUpdated?.toISOString()||null,stocksNeedingUpdate:d,expectedUniverseSize:12260,currentProgress:t?{stocksProcessed:r,successCount:a,failedCount:t.stocksFailed||0,totalStocks:r,isInitialLoad:"INITIAL_LOAD"===t.refreshType}:void 0};return i.NextResponse.json({status:p,logs:e})}catch(e){return console.error("Error fetching data refresh status:",e),i.NextResponse.json({error:e.message||"Failed to fetch data refresh status"},{status:500})}}async function f(e){let t=await (0,u.getServerSession)(d.L);if(!t?.user)return i.NextResponse.json({error:"Unauthorized"},{status:401});try{let{type:t="DELTA_REFRESH"}=await e.json();if(await c._.dataRefreshLog.findFirst({where:{status:"RUNNING"}}))return i.NextResponse.json({error:"A refresh is already in progress"},{status:409});let a=await c._.dataRefreshLog.create({data:{refreshType:t,status:"RUNNING"}}),{spawn:s}=r(61282),o="INITIAL_LOAD"===t?"download-stock-data":"refresh-stock-data";return s("yarn",["tsx",`scripts/${o}.ts`],{detached:!0,stdio:"ignore",cwd:process.cwd()}).unref(),i.NextResponse.json({message:"Data refresh started",refreshLogId:a.id,type:t})}catch(e){return console.error("Error starting data refresh:",e),i.NextResponse.json({error:e.message||"Failed to start data refresh"},{status:500})}}let h=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/data-refresh/route",pathname:"/api/data-refresh",filename:"route",bundlePath:"app/api/data-refresh/route"},resolvedPagePath:"/home/ubuntu/oshaughnessy_trader/nextjs_space/app/api/data-refresh/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:y,staticGenerationAsyncStorage:g,serverHooks:w}=h,_="/api/data-refresh/route";function m(){return(0,n.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:g})}},11826:(e,t,r)=>{r.d(t,{L:()=>d});var a=r(64617),s=r(66291),o=r(88120),n=r(3390),i=r.n(n),u=r(83178);let d={adapter:(0,a.N)(u._),providers:[(0,o.Z)({clientId:process.env.GOOGLE_CLIENT_ID||"",clientSecret:process.env.GOOGLE_CLIENT_SECRET||"",authorization:{params:{prompt:"consent",access_type:"offline",response_type:"code"}}}),(0,s.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;let t=await u._.user.findUnique({where:{email:e.email}});return t?.password&&await i().compare(e.password,t.password)?{id:t.id,email:t.email,name:t.name}:null}})],session:{strategy:"jwt"},pages:{signIn:"/auth/signin"},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id),e),session:async({session:e,token:t})=>(t&&e.user&&(e.user.id=t.id),e)}}},83178:(e,t,r)=>{r.d(t,{_:()=>s});var a=r(53524);let s=globalThis.prisma??new a.PrismaClient},23926:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},57978:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});var a={};Object.defineProperty(t,"default",{enumerable:!0,get:function(){return o.default}});var s=r(23926);Object.keys(s).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(a,e))&&(e in t&&t[e]===s[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return s[e]}}))});var o=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=n(void 0);if(r&&r.has(e))return r.get(e);var a={__proto__:null},s=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&({}).hasOwnProperty.call(e,o)){var i=s?Object.getOwnPropertyDescriptor(e,o):null;i&&(i.get||i.set)?Object.defineProperty(a,o,i):a[o]=e[o]}return a.default=e,r&&r.set(e,a),a}(r(15649));function n(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(n=function(e){return e?r:t})(e)}Object.keys(o).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(a,e))&&(e in t&&t[e]===o[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return o[e]}}))})}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[4372,7329,4178,7609],()=>r(23972));module.exports=a})();