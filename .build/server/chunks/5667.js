"use strict";exports.id=5667,exports.ids=[5667],exports.modules={84729:(e,t,i)=>{i.d(t,{p:()=>a});class r{constructor(e){this.config=e,this.baseUrl=e.isPaperTrading?"https://paper-api.alpaca.markets":"https://api.alpaca.markets"}async makeRequest(e,t={}){let i={"APCA-API-KEY-ID":this.config.apiKey,"APCA-API-SECRET-KEY":this.config.secretKey,"Content-Type":"application/json",...t.headers};try{let r=await fetch(`${this.baseUrl}${e}`,{...t,headers:i});if(!r.ok){let e=await r.text();throw Error(`Alpaca API error: ${r.status} - ${e}`)}return await r.json()}catch(t){throw console.error(`Alpaca API request failed for ${e}:`,t),t}}async getAccount(){return this.makeRequest("/v2/account")}async getPositions(){return this.makeRequest("/v2/positions")}async getPosition(e){return this.makeRequest(`/v2/positions/${e}`)}async getOrders(e){let t=e?`?status=${e}`:"";return this.makeRequest(`/v2/orders${t}`)}async getOrder(e){return this.makeRequest(`/v2/orders/${e}`)}async createOrder(e){return this.makeRequest("/v2/orders",{method:"POST",body:JSON.stringify(e)})}async cancelOrder(e){return this.makeRequest(`/v2/orders/${e}`,{method:"DELETE"})}async cancelAllOrders(){return this.makeRequest("/v2/orders",{method:"DELETE"})}async getPortfolioHistory(e,t){let i=new URLSearchParams;return e&&i.append("period",e),t&&i.append("timeframe",t),this.makeRequest(`/v2/account/portfolio/history?${i.toString()}`)}async getBars(e,t,i,r){let a=new URLSearchParams({symbols:e.join(","),timeframe:t});return i&&a.append("start",i),r&&a.append("end",r),this.makeRequest(`/v2/stocks/bars?${a.toString()}`)}async getLatestTrades(e){let t=new URLSearchParams({symbols:e.join(",")});return this.makeRequest(`/v2/stocks/trades/latest?${t.toString()}`)}async getLatestQuotes(e){let t=new URLSearchParams({symbols:e.join(",")});return this.makeRequest(`/v2/stocks/quotes/latest?${t.toString()}`)}}function a(e){return new r(e)}},63562:(e,t,i)=>{i.d(t,{J:()=>a});class r{get apiKey(){return process.env.FINNHUB_API_KEY||""}async getQuote(e){try{let t=await fetch(`${this.baseUrl}/quote?symbol=${e}&token=${this.apiKey}`);if(!t.ok)throw Error("Failed to fetch quote");return await t.json()}catch(t){return console.error(`Error fetching quote for ${e}:`,t),null}}async getCompanyProfile(e){try{let t=await fetch(`${this.baseUrl}/stock/profile2?symbol=${e}&token=${this.apiKey}`);if(!t.ok)throw Error("Failed to fetch company profile");return await t.json()}catch(t){return console.error(`Error fetching profile for ${e}:`,t),null}}async getCompanyFinancials(e,t="all"){try{let i=await fetch(`${this.baseUrl}/stock/metric?symbol=${e}&metric=${t}&token=${this.apiKey}`);if(!i.ok)throw Error("Failed to fetch financials");return await i.json()}catch(t){return console.error(`Error fetching financials for ${e}:`,t),null}}async getCompanyNews(e,t,i){try{let r=await fetch(`${this.baseUrl}/company-news?symbol=${e}&from=${t}&to=${i}&token=${this.apiKey}`);if(!r.ok)throw Error("Failed to fetch news");return await r.json()}catch(t){return console.error(`Error fetching news for ${e}:`,t),[]}}async getNewsSentiment(e){try{let t=await fetch(`${this.baseUrl}/news-sentiment?symbol=${e}&token=${this.apiKey}`);if(!t.ok)throw Error("Failed to fetch news sentiment");return await t.json()}catch(t){return console.error(`Error fetching news sentiment for ${e}:`,t),null}}async getEarningsCalendar(e,t){try{let i=`${this.baseUrl}/calendar/earnings?from=${e}&to=${t}&token=${this.apiKey}`,r=await fetch(i);if(!r.ok)throw Error(`Failed to fetch earnings calendar: ${r.status}`);return await r.json()}catch(e){return console.error("Error fetching earnings calendar:",e),{earningsCalendar:[]}}}async getStockSymbols(e="US"){try{let t=`${this.baseUrl}/stock/symbol?exchange=${e}&token=${this.apiKey}`,i=await fetch(t);if(!i.ok){let e=await i.text();throw console.error(`Finnhub API error (${i.status}):`,e),Error(`Failed to fetch stock symbols: ${i.status}`)}return await i.json()}catch(e){return console.error("Error fetching stock symbols:",e),[]}}async getHistoricalPrices(e,t,i,r){try{let a=await fetch(`${this.baseUrl}/stock/candle?symbol=${e}&resolution=${t}&from=${i}&to=${r}&token=${this.apiKey}`);if(!a.ok)throw Error("Failed to fetch historical prices");let n=await a.json();if("no_data"===n.s)return null;return n}catch(t){return console.error(`Error fetching historical prices for ${e}:`,t),null}}async getCompanyEarnings(e,t=4){try{let i=await fetch(`${this.baseUrl}/stock/earnings?symbol=${e}&limit=${t}&token=${this.apiKey}`);if(!i.ok)throw Error("Failed to fetch company earnings");return await i.json()}catch(t){return console.error(`Error fetching earnings for ${e}:`,t),null}}constructor(){this.baseUrl="https://finnhub.io/api/v1"}}let a=new r},85667:(e,t,i)=>{i.d(t,{tradingEngine:()=>u});var r=i(83178),a=i(63562),n=i(84729),o=i(92048),s=i.n(o);class l{loadSecrets(){if(this.secretsLoaded)return;let e=function(){try{let e=process.env.AUTH_SECRETS_PATH||`${process.env.HOME}/.config/abacusai_auth_secrets.json`;if(!s().existsSync(e))return console.warn("Auth secrets file not found at:",e),{};return JSON.parse(s().readFileSync(e,"utf8"))}catch(e){return console.error("Failed to load auth secrets:",e),{}}}();this.sendGridApiKey=e?.sendgrid?.secrets?.api_key?.value||null,this.slackAccessToken=e?.slack?.secrets?.access_token?.value||null,this.secretsLoaded=!0}async sendTradeNotification(e){this.loadSecrets();try{let t=await r._.tradingAccount.findUnique({where:{userId:e.userId},include:{user:!0}});if(!t){console.error("Trading account not found for user:",e.userId);return}let i=await this.createInAppNotification(e);t.emailNotifications&&this.sendGridApiKey&&(await this.sendTradeEmail(t.user.email,e),await r._.notification.update({where:{id:i.id},data:{emailSent:!0}})),t.slackNotifications&&this.slackAccessToken&&t.slackChannel&&(await this.sendSlackMessage(t.slackChannel,e),await r._.notification.update({where:{id:i.id},data:{slackSent:!0}}))}catch(e){console.error("Error sending trade notification:",e)}}async createInAppNotification(e){let t="BUY"===e.action,i=t?`üìà Bought ${e.ticker}`:`üìâ Sold ${e.ticker}`,a=`${e.action} ${e.quantity} shares at $${e.price.toFixed(2)}`;if(!t&&void 0!==e.pnl){let t=e.pnl>=0?"+":"";a+=` ‚Ä¢ P&L: ${t}$${e.pnl.toFixed(2)}`}return e.reason&&(a+=` ‚Ä¢ Reason: ${e.reason}`),await r._.notification.create({data:{userId:e.userId,type:t?"TRADE_BUY":"TRADE_SELL",title:i,message:a,ticker:e.ticker,action:e.action,quantity:e.quantity,price:e.price,pnl:e.pnl||null}})}async sendTradeEmail(e,t){if(!this.sendGridApiKey){console.warn("SendGrid API key not configured");return}let i="BUY"===t.action,r=`Trade Alert: ${t.action} ${t.ticker}`,a=`
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <div style="background: ${i?"#10b981":"#ef4444"}; color: white; padding: 20px; border-radius: 8px 8px 0 0;">
          <h2 style="margin: 0;">${i?"\uD83D\uDCC8":"\uD83D\uDCC9"} ${t.action} ${t.ticker}</h2>
        </div>
        <div style="background: #f9fafb; padding: 20px; border-radius: 0 0 8px 8px;">
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 10px; font-weight: bold;">Symbol:</td>
              <td style="padding: 10px;">${t.ticker}</td>
            </tr>
            <tr>
              <td style="padding: 10px; font-weight: bold;">Action:</td>
              <td style="padding: 10px;">${t.action}</td>
            </tr>
            <tr>
              <td style="padding: 10px; font-weight: bold;">Quantity:</td>
              <td style="padding: 10px;">${t.quantity} shares</td>
            </tr>
            <tr>
              <td style="padding: 10px; font-weight: bold;">Price:</td>
              <td style="padding: 10px;">$${t.price.toFixed(2)}</td>
            </tr>
    `;if(!i&&t.entryPrice&&(a+=`
            <tr>
              <td style="padding: 10px; font-weight: bold;">Entry Price:</td>
              <td style="padding: 10px;">$${t.entryPrice.toFixed(2)}</td>
            </tr>
      `),!i&&void 0!==t.pnl){let e=t.pnl>=0?"#10b981":"#ef4444";a+=`
            <tr>
              <td style="padding: 10px; font-weight: bold;">P&L:</td>
              <td style="padding: 10px; color: ${e}; font-weight: bold;">
                ${t.pnl>=0?"+":""}$${t.pnl.toFixed(2)}
              </td>
            </tr>
      `}t.reason&&(a+=`
            <tr>
              <td style="padding: 10px; font-weight: bold;">Reason:</td>
              <td style="padding: 10px;">${t.reason}</td>
            </tr>
      `),a+=`
          </table>
          <p style="margin-top: 20px; font-size: 12px; color: #6b7280;">
            This is an automated notification from News Trader. 
            <a href="https://trader.cloudstacknetworks.com/dashboard/settings" style="color: #3b82f6;">Manage notification preferences</a>
          </p>
        </div>
      </div>
    `;try{let t=await fetch("https://api.sendgrid.com/v3/mail/send",{method:"POST",headers:{Authorization:`Bearer ${this.sendGridApiKey}`,"Content-Type":"application/json"},body:JSON.stringify({personalizations:[{to:[{email:e}]}],from:{email:"trading@cloudstacknetworks.com",name:"News Trader"},subject:r,content:[{type:"text/html",value:a}]})});if(!t.ok)throw Error(`SendGrid API error: ${t.status}`)}catch(e){console.error("Failed to send trade email:",e)}}async sendSlackMessage(e,t){if(!this.slackAccessToken){console.warn("Slack access token not configured");return}let i="BUY"===t.action,r=`${i?"\uD83D\uDCC8":"\uD83D\uDCC9"} *${t.action} ${t.ticker}*
`;r+=`‚Ä¢ Quantity: ${t.quantity} shares
‚Ä¢ Price: $${t.price.toFixed(2)}
`,!i&&t.entryPrice&&(r+=`‚Ä¢ Entry Price: $${t.entryPrice.toFixed(2)}
`),i||void 0===t.pnl||(r+=`‚Ä¢ P&L: ${t.pnl>=0?"+":""}$${t.pnl.toFixed(2)}
`),t.reason&&(r+=`‚Ä¢ Reason: ${t.reason}`);try{let t=await fetch("https://slack.com/api/chat.postMessage",{method:"POST",headers:{Authorization:`Bearer ${this.slackAccessToken}`,"Content-Type":"application/json"},body:JSON.stringify({channel:e,text:r,attachments:[{color:i?"#10b981":"#ef4444",footer:"News Trader ‚Ä¢ CloudStack Networks",ts:Math.floor(Date.now()/1e3)}]})}),a=await t.json();if(!a.ok)throw Error(`Slack API error: ${a.error}`)}catch(e){console.error("Failed to send Slack message:",e)}}async sendDailySummary(e){this.loadSecrets();try{let t=await r._.tradingAccount.findUnique({where:{userId:e.userId},include:{user:!0}});if(!t||!t.dailySummaryEmail)return;let i=e.totalTrades>0?(e.winningTrades/e.totalTrades*100).toFixed(1):"0.0";await r._.notification.create({data:{userId:e.userId,type:"DAILY_SUMMARY",title:"\uD83D\uDCCA Daily Trading Summary",message:`${e.totalTrades} trades ‚Ä¢ ${i}% win rate ‚Ä¢ ${e.totalPnl>=0?"+":""}$${e.totalPnl.toFixed(2)} P&L`}}),t.emailNotifications&&this.sendGridApiKey&&await this.sendDailySummaryEmail(t.user.email,e,i),t.slackNotifications&&this.slackAccessToken&&t.slackChannel&&await this.sendDailySummarySlack(t.slackChannel,e,i)}catch(e){console.error("Error sending daily summary:",e)}}async sendDailySummaryEmail(e,t,i){if(!this.sendGridApiKey)return;let r=t.totalPnl>=0?"#10b981":"#ef4444",a=t.totalPnl>=0?"+":"",n=`
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 8px 8px 0 0;">
          <h1 style="margin: 0; font-size: 24px;">üìä Daily Trading Summary</h1>
          <p style="margin: 5px 0 0 0; opacity: 0.9;">${new Date().toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}</p>
        </div>
        <div style="background: #f9fafb; padding: 30px; border-radius: 0 0 8px 8px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <div style="color: #6b7280; font-size: 14px; margin-bottom: 5px;">Total Trades</div>
              <div style="font-size: 32px; font-weight: bold;">${t.totalTrades}</div>
            </div>
            <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <div style="color: #6b7280; font-size: 14px; margin-bottom: 5px;">Win Rate</div>
              <div style="font-size: 32px; font-weight: bold; color: #10b981;">${i}%</div>
            </div>
          </div>
          
          <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px;">
            <div style="color: #6b7280; font-size: 14px; margin-bottom: 5px;">Total P&L</div>
            <div style="font-size: 36px; font-weight: bold; color: ${r};">${a}$${t.totalPnl.toFixed(2)}</div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <div style="color: #6b7280; font-size: 12px;">Winning Trades</div>
              <div style="font-size: 20px; font-weight: bold; color: #10b981;">${t.winningTrades}</div>
            </div>
            <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <div style="color: #6b7280; font-size: 12px;">Losing Trades</div>
              <div style="font-size: 20px; font-weight: bold; color: #ef4444;">${t.losingTrades}</div>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <div style="color: #6b7280; font-size: 12px;">Open Positions</div>
              <div style="font-size: 20px; font-weight: bold;">${t.openPositions}</div>
            </div>
            <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <div style="color: #6b7280; font-size: 12px;">Closed Today</div>
              <div style="font-size: 20px; font-weight: bold;">${t.closedPositions}</div>
            </div>
          </div>

          ${t.topPerformer?`
          <div style="background: #d1fae5; padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #10b981;">
            <div style="color: #065f46; font-size: 12px; font-weight: bold; margin-bottom: 5px;">üèÜ TOP PERFORMER</div>
            <div style="color: #047857; font-size: 18px; font-weight: bold;">
              ${t.topPerformer.ticker} ‚Ä¢ +$${t.topPerformer.pnl.toFixed(2)}
            </div>
          </div>
          `:""}

          ${t.worstPerformer&&t.worstPerformer.pnl<0?`
          <div style="background: #fee2e2; padding: 15px; border-radius: 8px; margin-top: 10px; border-left: 4px solid #ef4444;">
            <div style="color: #991b1b; font-size: 12px; font-weight: bold; margin-bottom: 5px;">üìâ WORST PERFORMER</div>
            <div style="color: #dc2626; font-size: 18px; font-weight: bold;">
              ${t.worstPerformer.ticker} ‚Ä¢ $${t.worstPerformer.pnl.toFixed(2)}
            </div>
          </div>
          `:""}

          <div style="margin-top: 30px; text-align: center;">
            <a href="https://trader.cloudstacknetworks.com/dashboard/trades" 
               style="display: inline-block; background: #3b82f6; color: white; padding: 12px 24px; 
                      border-radius: 6px; text-decoration: none; font-weight: bold;">
              View Full Trade History
            </a>
          </div>

          <p style="margin-top: 30px; font-size: 12px; color: #6b7280; text-align: center;">
            News Trader ‚Ä¢ CloudStack Networks<br>
            <a href="https://trader.cloudstacknetworks.com/dashboard/settings" style="color: #3b82f6;">Manage notification preferences</a>
          </p>
        </div>
      </div>
    `;try{let i=await fetch("https://api.sendgrid.com/v3/mail/send",{method:"POST",headers:{Authorization:`Bearer ${this.sendGridApiKey}`,"Content-Type":"application/json"},body:JSON.stringify({personalizations:[{to:[{email:e}]}],from:{email:"trading@cloudstacknetworks.com",name:"News Trader"},subject:`Daily Summary: ${a}$${t.totalPnl.toFixed(2)} ‚Ä¢ ${t.totalTrades} trades`,content:[{type:"text/html",value:n}]})});if(!i.ok)throw Error(`SendGrid API error: ${i.status}`)}catch(e){console.error("Failed to send daily summary email:",e)}}async sendDailySummarySlack(e,t,i){if(!this.slackAccessToken)return;let r=t.totalPnl>=0?"+":"",a=t.totalPnl>=0?"\uD83D\uDCB0":"\uD83D\uDCC9",n=`üìä *Daily Trading Summary*

`;n+=`${a} *Total P&L:* ${r}$${t.totalPnl.toFixed(2)}
üìà *Total Trades:* ${t.totalTrades}
‚úÖ *Win Rate:* ${i}%
üü¢ *Winning:* ${t.winningTrades} | üî¥ *Losing:* ${t.losingTrades}
üìä *Open:* ${t.openPositions} | ‚úîÔ∏è *Closed Today:* ${t.closedPositions}
`,t.topPerformer&&(n+=`
üèÜ *Top Performer:* ${t.topPerformer.ticker} (+$${t.topPerformer.pnl.toFixed(2)})`),t.worstPerformer&&t.worstPerformer.pnl<0&&(n+=`
üìâ *Worst Performer:* ${t.worstPerformer.ticker} ($${t.worstPerformer.pnl.toFixed(2)})`);try{let i=await fetch("https://slack.com/api/chat.postMessage",{method:"POST",headers:{Authorization:`Bearer ${this.slackAccessToken}`,"Content-Type":"application/json"},body:JSON.stringify({channel:e,text:n,attachments:[{color:t.totalPnl>=0?"#10b981":"#ef4444",footer:`News Trader ‚Ä¢ ${new Date().toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}`,ts:Math.floor(Date.now()/1e3)}]})}),r=await i.json();if(!r.ok)throw Error(`Slack API error: ${r.error}`)}catch(e){console.error("Failed to send daily summary to Slack:",e)}}async sendNoEarningsOpportunities(e){this.loadSecrets();try{let t=await r._.tradingAccount.findUnique({where:{userId:e.userId},include:{user:!0}});if(!t||!t.emailNotifications)return;this.sendGridApiKey&&await this.sendNoEarningsOpportunitiesEmail(e),await r._.notification.create({data:{userId:e.userId,type:"DAILY_SUMMARY",title:`üìä ${e.screenName} - No Opportunities Today`,message:`Monitored ${e.monitoredStocks.length} stocks. None exceeded ${e.minSurpriseThreshold}% earnings surprise threshold.`}})}catch(e){console.error("Error sending no earnings opportunities notification:",e)}}async sendNoEarningsOpportunitiesEmail(e){if(!this.sendGridApiKey)return;let t=e.monitoredStocks.filter(e=>null!==e.actualEPS),i=e.monitoredStocks.filter(e=>null===e.actualEPS),r=e.monitoredStocks.map(t=>{let i="",r="#6b7280";null===t.actualEPS?(i="Pending",r="#f59e0b"):null!==t.surprise?t.surprise>=e.minSurpriseThreshold?(i=`‚úì Beat (+${t.surprise.toFixed(1)}%)`,r="#10b981"):t.surprise>0?(i=`Beat (+${t.surprise.toFixed(1)}%)`,r="#3b82f6"):(i=`Miss (${t.surprise.toFixed(1)}%)`,r="#ef4444"):(i="Reported",r="#6b7280");let a=t.reason||(null!==t.surprise&&t.surprise<e.minSurpriseThreshold?`Below ${e.minSurpriseThreshold}% threshold`:"N/A");return`
        <tr style="border-bottom: 1px solid #e5e7eb;">
          <td style="padding: 12px 8px; font-weight: bold;">${t.ticker}</td>
          <td style="padding: 12px 8px;">${t.earningsDate?new Date(t.earningsDate).toLocaleDateString("en-US",{month:"short",day:"numeric"}):"N/A"}</td>
          <td style="padding: 12px 8px; text-align: center;">${null!==t.estimatedEPS?"$"+t.estimatedEPS.toFixed(2):"N/A"}</td>
          <td style="padding: 12px 8px; text-align: center;">${null!==t.actualEPS?"$"+t.actualEPS.toFixed(2):"-"}</td>
          <td style="padding: 12px 8px; text-align: center;">${null!==t.surprise?t.surprise.toFixed(1)+"%":"-"}</td>
          <td style="padding: 12px 8px;">
            <span style="display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; 
                         background: ${r}20; color: ${r};">
              ${i}
            </span>
          </td>
          <td style="padding: 12px 8px; font-size: 13px; color: #6b7280;">${a}</td>
        </tr>
      `}).join(""),a=`
      <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 8px 8px 0 0;">
          <h1 style="margin: 0; font-size: 24px;">üìä Earnings Monitor Report</h1>
          <p style="margin: 10px 0 0 0; font-size: 16px; opacity: 0.9;">${e.screenName}</p>
          <p style="margin: 5px 0 0 0; opacity: 0.8; font-size: 14px;">${e.date.toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}</p>
        </div>
        
        <div style="background: #f9fafb; padding: 30px; border-radius: 0 0 8px 8px;">
          <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 16px; border-radius: 6px; margin-bottom: 24px;">
            <div style="color: #92400e; font-weight: bold; margin-bottom: 8px;">‚ö†Ô∏è No Trading Opportunities Found</div>
            <div style="color: #78350f; font-size: 14px;">
              None of your ${e.monitoredStocks.length} monitored stocks exceeded the ${e.minSurpriseThreshold}% earnings surprise threshold today.
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 24px;">
            <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center;">
              <div style="color: #6b7280; font-size: 14px; margin-bottom: 5px;">Monitored</div>
              <div style="font-size: 28px; font-weight: bold; color: #3b82f6;">${e.monitoredStocks.length}</div>
            </div>
            <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center;">
              <div style="color: #6b7280; font-size: 14px; margin-bottom: 5px;">Reported</div>
              <div style="font-size: 28px; font-weight: bold; color: #10b981;">${t.length}</div>
            </div>
            <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center;">
              <div style="color: #6b7280; font-size: 14px; margin-bottom: 5px;">Pending</div>
              <div style="font-size: 28px; font-weight: bold; color: #f59e0b;">${i.length}</div>
            </div>
          </div>

          <div style="background: white; padding: 24px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px;">
            <h2 style="margin: 0 0 16px 0; font-size: 18px; color: #111827;">Earnings Details</h2>
            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                <thead>
                  <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                    <th style="padding: 12px 8px; text-align: left; font-weight: 600; color: #374151;">Ticker</th>
                    <th style="padding: 12px 8px; text-align: left; font-weight: 600; color: #374151;">Date</th>
                    <th style="padding: 12px 8px; text-align: center; font-weight: 600; color: #374151;">Est. EPS</th>
                    <th style="padding: 12px 8px; text-align: center; font-weight: 600; color: #374151;">Actual EPS</th>
                    <th style="padding: 12px 8px; text-align: center; font-weight: 600; color: #374151;">Surprise</th>
                    <th style="padding: 12px 8px; text-align: left; font-weight: 600; color: #374151;">Status</th>
                    <th style="padding: 12px 8px; text-align: left; font-weight: 600; color: #374151;">Why Not Traded</th>
                  </tr>
                </thead>
                <tbody>
                  ${r}
                </tbody>
              </table>
            </div>
          </div>

          <div style="background: #eff6ff; border-left: 4px solid #3b82f6; padding: 16px; border-radius: 6px; margin-bottom: 24px;">
            <div style="color: #1e40af; font-weight: bold; margin-bottom: 8px;">üí° Next Steps</div>
            <div style="color: #1e3a8a; font-size: 14px;">
              ‚Ä¢ Review your earnings surprise threshold (currently ${e.minSurpriseThreshold}%)<br>
              ‚Ä¢ Check if any pending earnings might report later today<br>
              ‚Ä¢ Consider adjusting your monitored stocks list<br>
              ‚Ä¢ The system will automatically trade when opportunities meet your criteria
            </div>
          </div>

          <div style="margin-top: 30px; text-align: center;">
            <a href="https://trader.cloudstacknetworks.com/dashboard/earnings-results/${e.screenId}" 
               style="display: inline-block; background: #3b82f6; color: white; padding: 12px 24px; 
                      border-radius: 6px; text-decoration: none; font-weight: bold; margin-right: 10px;">
              View Full Report
            </a>
            <a href="https://trader.cloudstacknetworks.com/dashboard/screens" 
               style="display: inline-block; background: #6b7280; color: white; padding: 12px 24px; 
                      border-radius: 6px; text-decoration: none; font-weight: bold;">
              Edit Screen Settings
            </a>
          </div>

          <p style="margin-top: 30px; font-size: 12px; color: #6b7280; text-align: center;">
            News Trader ‚Ä¢ CloudStack Networks<br>
            This is an automated daily earnings monitor report.<br>
            <a href="https://trader.cloudstacknetworks.com/dashboard/settings" style="color: #3b82f6;">Manage notification preferences</a>
          </p>
        </div>
      </div>
    `;try{let r=await fetch("https://api.sendgrid.com/v3/mail/send",{method:"POST",headers:{Authorization:`Bearer ${this.sendGridApiKey}`,"Content-Type":"application/json"},body:JSON.stringify({personalizations:[{to:[{email:e.userEmail}]}],from:{email:"trading@cloudstacknetworks.com",name:"News Trader"},subject:`Earnings Monitor: ${e.screenName} - No Opportunities (${t.length} reported, ${i.length} pending)`,content:[{type:"text/html",value:a}]})});if(!r.ok){let e=await r.text();throw Error(`SendGrid API error: ${r.status} - ${e}`)}console.log(`‚úÖ Sent no-opportunities email to ${e.userEmail} for screen "${e.screenName}"`)}catch(e){console.error("Failed to send no earnings opportunities email:",e)}}constructor(){this.sendGridApiKey=null,this.slackAccessToken=null,this.secretsLoaded=!1}}let d=new l;class c{async initializeAlpaca(e){let t=await r._.tradingAccount.findUnique({where:{userId:e}});if(!t?.alpacaApiKey||!t?.alpacaSecretKey)throw Error("Alpaca API credentials not configured");return this.alpacaClient=(0,n.p)({apiKey:t.alpacaApiKey,secretKey:t.alpacaSecretKey,isPaperTrading:t.isPaperTrading}),this.alpacaClient}async runOShaughnessyScreening(e){console.log("Starting O'Shaughnessy screening (LOCAL DATA MODE)...");let t=await r._.screen.findMany({where:e?{id:e}:{isActive:!0}});if(0===t.length)return console.log("No screens found to run"),{message:"No screens found",screensProcessed:0,stocksFound:0};let i=0;for(let a of t){console.log(`
========================================`),console.log(`Running screen: ${a.name} (ID: ${a.id})`),console.log("========================================");let t={hasError:!1,dataQuality:{gte:30}};(a.minPE||a.maxPE||a.peRatioMax)&&(t.peRatio={gte:a.minPE?Number(a.minPE):void 0,lte:a.maxPE||a.peRatioMax?Number(a.maxPE||a.peRatioMax):void 0,not:null}),(a.minPS||a.maxPS||a.psRatioMax)&&(t.psRatio={gte:a.minPS?Number(a.minPS):void 0,lte:a.maxPS||a.psRatioMax?Number(a.maxPS||a.psRatioMax):void 0,not:null}),(a.minPB||a.maxPB)&&(t.pbRatio={gte:a.minPB?Number(a.minPB):void 0,lte:a.maxPB?Number(a.maxPB):void 0,not:null}),(a.minPCF||a.maxPCF)&&(t.pcfRatio={gte:a.minPCF?Number(a.minPCF):void 0,lte:a.maxPCF?Number(a.maxPCF):void 0,not:null}),(a.minROE||a.maxROE)&&(t.roe={gte:a.minROE?Number(a.minROE):void 0,lte:a.maxROE?Number(a.maxROE):void 0,not:null}),(a.minDebtToEquity||a.maxDebtToEquity)&&(t.debtToEquity={gte:a.minDebtToEquity?Number(a.minDebtToEquity):void 0,lte:a.maxDebtToEquity?Number(a.maxDebtToEquity):void 0,not:null}),(a.minCurrentRatio||a.maxCurrentRatio)&&(t.currentRatio={gte:a.minCurrentRatio?Number(a.minCurrentRatio):void 0,lte:a.maxCurrentRatio?Number(a.maxCurrentRatio):void 0,not:null}),(a.minRevenueGrowth||a.maxRevenueGrowth)&&(t.revenueGrowth={gte:a.minRevenueGrowth?Number(a.minRevenueGrowth):void 0,lte:a.maxRevenueGrowth?Number(a.maxRevenueGrowth):void 0,not:null}),(a.minEarningsGrowth||a.maxEarningsGrowth)&&(t.earningsGrowth={gte:a.minEarningsGrowth?Number(a.minEarningsGrowth):void 0,lte:a.maxEarningsGrowth?Number(a.maxEarningsGrowth):void 0,not:null}),(a.minDividendYield||a.maxDividendYield)&&(t.dividendYield={gte:a.minDividendYield?Number(a.minDividendYield):void 0,lte:a.maxDividendYield?Number(a.maxDividendYield):void 0,not:null}),(a.marketCapMin||a.minMarketCap||a.maxMarketCap)&&(t.marketCap={gte:a.marketCapMin||a.minMarketCap?Number(a.marketCapMin||a.minMarketCap):void 0,lte:a.maxMarketCap?Number(a.maxMarketCap):void 0,not:null}),(a.minVolume||a.maxVolume)&&(t.volume={gte:a.minVolume?BigInt(Math.floor(Number(a.minVolume))):void 0,lte:a.maxVolume?BigInt(Math.floor(Number(a.maxVolume))):void 0,not:null}),(a.minMomentum||a.momentumMin||a.maxMomentum)&&(t.momentum3M={gte:a.minMomentum||a.momentumMin?Number(a.minMomentum||a.momentumMin):void 0,lte:a.maxMomentum?Number(a.maxMomentum):void 0,not:null}),console.log("Querying local database...");let n=Date.now(),o=await r._.stockData.findMany({where:t,orderBy:[{dataQuality:"desc"},{marketCap:"desc"}],take:200}),s=Date.now()-n;console.log(`Query completed in ${s}ms - found ${o.length} stocks`);let l=o.map(e=>{let t=e.peRatio?Number(e.peRatio):null,i=e.psRatio?Number(e.psRatio):null,r=e.pbRatio?Number(e.pbRatio):null,a=e.momentum3M?Number(e.momentum3M):0,n=((t&&t>0?Math.max(0,Math.min(10,10-t/3)):5)+(i&&i>0?Math.max(0,Math.min(10,10-3*i)):5)+(r&&r>0?Math.max(0,Math.min(10,10-r/2)):5)+Math.max(0,Math.min(10,5+a/4)))/4;return{ticker:e.symbol,score:n,peRatio:t||0,psRatio:i||0,momentum:a,marketCap:e.marketCap?Number(e.marketCap):0,currentPrice:e.currentPrice?Number(e.currentPrice):0}});l.sort((e,t)=>t.score-e.score);let d=l.slice(0,50);for(let t of(console.log(`Top stock: ${d[0]?.ticker} (score: ${d[0]?.score.toFixed(2)})`),e&&(await r._.watchlistItem.deleteMany({where:{screenId:a.id}}),console.log(`Cleared existing watchlist items for screen: ${a.name}`)),d))await r._.watchlistItem.upsert({where:{ticker_screenId:{ticker:t.ticker,screenId:a.id}},update:{...t,lastNewsCheck:new Date},create:{...t,screenId:a.id,lastNewsCheck:new Date}});i+=d.length,console.log(`Added ${d.length} stocks to watchlist for screen: ${a.name}
`)}return console.log("========================================"),console.log("Screening completed successfully!"),console.log(`Total stocks added across all screens: ${i}`),console.log("========================================"),{message:"Screening completed successfully",screensProcessed:t.length,stocksFound:i}}async analyzeNews(e){try{let t=new Date,i=new Date(t.getTime()-864e5),r=await a.J.getCompanyNews(e,i.toISOString().split("T")[0],t.toISOString().split("T")[0]),n=await a.J.getNewsSentiment(e);return{newsCount:r?.length||0,sentimentScore:n?.sentiment?.bearishPercent?(n.sentiment.bullishPercent-n.sentiment.bearishPercent)/100:Math.random()-.5,hasEarnings:r?.some(e=>e.headline?.toLowerCase().includes("earnings")||e.headline?.toLowerCase().includes("results"))||!1}}catch(t){return console.error(`Error analyzing news for ${e}:`,t),{newsCount:0,sentimentScore:0,hasEarnings:!1}}}async updateScreenCapital(e,t,i){let a=await r._.screen.findUnique({where:{id:e}});if(!a||!a.allocatedCapital)return;let n=Number(a.currentCapital||a.allocatedCapital)+t,o=[];if(a.dailyCapitalHistory)try{o=JSON.parse(a.dailyCapitalHistory)}catch(e){o=[]}let s=new Date().toISOString().split("T")[0],l=o.findIndex(e=>e.date===s);l>=0?o[l]={date:s,capital:n,pnl:o[l].pnl+t}:o.push({date:s,capital:n,pnl:t}),o=o.slice(-90),await r._.screen.update({where:{id:e},data:{currentCapital:n,dailyCapitalHistory:JSON.stringify(o)}}),console.log(`[Capital Tracking] Screen ${a.name}: ${i} | Change: $${t.toFixed(2)} | New Capital: $${n.toFixed(2)}`)}async identifyTradingOpportunities(e){let t=await r._.tradingAccount.findUnique({where:{userId:e}});if(!t)throw Error("Trading account not found");let i=await r._.watchlistItem.findMany({take:20,orderBy:[{score:"desc"},{dateAdded:"desc"}]}),a=[];for(let e of i)try{let t=await this.analyzeNews(e.ticker);await r._.watchlistItem.update({where:{id:e.id},data:{newsCount:t.newsCount,sentimentScore:t.sentimentScore,lastNewsCheck:new Date}});let i=Number(e.score);i>7&&t.sentimentScore>.3&&(t.newsCount>2||t.hasEarnings)&&a.push({...e,score:i,newsCount:t.newsCount,sentimentScore:t.sentimentScore,hasEarnings:t.hasEarnings,opportunityScore:i+2*t.sentimentScore})}catch(t){console.error(`Error analyzing opportunity for ${e.ticker}:`,t)}return a.sort((e,t)=>t.opportunityScore-e.opportunityScore),a.slice(0,Math.min(5,t.maxPositions))}async identifyEarningsOpportunities(e,t){let i=await r._.tradingAccount.findUnique({where:{userId:t}});if(!i)throw Error("Trading account not found");let a=await r._.screen.findUnique({where:{id:e},include:{watchlistItems:{select:{ticker:!0}}}});if(!a||"EARNINGS"!==a.screenType)throw Error("Invalid earnings screen");let n=a.watchlistItems.map(e=>e.ticker);if(0===n.length)return console.log(`‚ö†Ô∏è  No watchlist items found for screen ${a.name}`),[];console.log(`üìä Checking earnings for ${n.length} monitored stocks: ${n.join(", ")}`);let o=new Date().toISOString().split("T")[0],s={symbol:{in:n},earningsDate:{gte:new Date(o),lt:new Date(new Date(o).getTime()+864e5)},beat:!0,surprise:{gte:Number(a.minEarningsSurprise||5)}},l=await r._.earningsCalendar.findMany({where:s}),c=[];for(let e of(console.log(`‚úÖ Found ${l.length} earnings reports that beat expectations by ‚â•${a.minEarningsSurprise}%`),l))try{let t=await r._.stockData.findUnique({where:{symbol:e.symbol}});if(!t){console.log(`‚ö†Ô∏è  ${e.symbol}: No stock data in database - skipping`);continue}if(t.hasError){console.log(`‚ö†Ô∏è  ${e.symbol}: Stock data has errors - skipping`);continue}if(!t.currentPrice){console.log(`‚ö†Ô∏è  ${e.symbol}: No current price available - skipping`);continue}let i=Number(e.surprise||0);console.log(`\u2705 ${e.symbol}: Qualified earnings beat - surprise ${e.surprise?.toFixed(1)}%, price $${Number(t.currentPrice).toFixed(2)}`),c.push({ticker:e.symbol,companyName:t.companyName,currentPrice:Number(t.currentPrice),surprise:Number(e.surprise),actualEPS:Number(e.actualEPS),estimatedEPS:Number(e.estimatedEPS),opportunityScore:i,reason:`Earnings beat by ${e.surprise?.toFixed(1)}%`})}catch(t){console.error(`\u274c Error analyzing earnings opportunity for ${e.symbol}:`,t)}c.sort((e,t)=>t.surprise-e.surprise);let u=a.maxPositions||10,m=Math.min(u,i.maxPositions),p=c.slice(0,m);if(console.log(`
üìä Max Positions Config: Screen limit = ${u}, Account limit = ${i.maxPositions}, Effective = ${m}`),console.log(`üéØ Top opportunities to trade: ${p.length} (from ${c.length} qualified)`),!i.automationEnabled)return console.log(`‚ö†Ô∏è  Automation is disabled - skipping trade execution`),p;console.log(`‚úÖ Automation enabled - executing trades...`);let g=Number(i.startingCapital);a.allocatedCapital&&Number(a.allocatedCapital)>0&&(g=Number(a.currentCapital||a.allocatedCapital),console.log(`üí∞ Using screen capital: $${g.toFixed(2)}`));let h=p.length>0?g/p.length:g/Number(i.maxPositions);console.log(`üìä Dynamic Position Sizing: $${g.toFixed(2)} \xf7 ${p.length} opportunities = $${h.toFixed(2)} per position`);let y=[];for(let e of p)try{console.log(`
üíº Executing BUY for ${e.ticker} @ $${e.currentPrice.toFixed(2)}`);let n=Math.floor(h/e.currentPrice);if(n<=0){console.log(`   ‚ö†Ô∏è  Insufficient capital for ${e.ticker} - skipping`);continue}console.log(`   Quantity: ${n} shares ($${(n*e.currentPrice).toFixed(2)})`);let o=await r._.watchlistItem.findFirst({where:{ticker:e.ticker,screenId:a.id}});o||(console.log(`   ‚ÑπÔ∏è  Creating watchlist item for ${e.ticker}`),o=await r._.watchlistItem.create({data:{ticker:e.ticker,screenId:a.id,score:e.opportunityScore,dateAdded:new Date}}));let s=await r._.position.create({data:{userId:t,ticker:e.ticker,watchlistItemId:o.id,quantity:n,entryPrice:e.currentPrice,currentPrice:e.currentPrice,unrealizedPnl:0,trailingStopPrice:e.currentPrice*(1-Number(i.trailingStopPct)/100),entryTime:new Date,status:"OPEN",alpacaOrderId:`SIM-${Date.now()}-${e.ticker}`}});if(await r._.trade.create({data:{userId:t,ticker:e.ticker,watchlistItemId:o.id,quantity:n,entryPrice:e.currentPrice,entryTime:new Date,alpacaEntryOrderId:`SIM-${Date.now()}-${e.ticker}`,strategy:`EARNINGS_BEAT_${a.name}`}}),a.allocatedCapital&&Number(a.allocatedCapital)>0){let t=n*e.currentPrice;await this.updateScreenCapital(a.id,-t,`BUY ${e.ticker} x${n} @ $${e.currentPrice.toFixed(2)} (Earnings beat +${e.surprise.toFixed(1)}%)`)}console.log(`   ‚úÖ Trade executed: BUY ${n} ${e.ticker} @ $${e.currentPrice.toFixed(2)}`);try{await d.sendTradeNotification({userId:t,ticker:e.ticker,action:"BUY",quantity:n,price:e.currentPrice,reason:e.reason})}catch(e){console.error(`   ‚ö†Ô∏è  Failed to send notification:`,e)}y.push({...e,quantity:n,positionId:s.id})}catch(t){console.error(`   ‚ùå Error executing trade for ${e.ticker}:`,t.message)}return console.log(`
‚úÖ Executed ${y.length} trades`),y}passesScreenCriteria(e,t){return!(null!==t.minPE&&void 0!==t.minPE&&(null===e.peRatio||Number(e.peRatio)<Number(t.minPE))||null!==t.maxPE&&void 0!==t.maxPE&&(null===e.peRatio||Number(e.peRatio)>Number(t.maxPE))||null!==t.minPS&&void 0!==t.minPS&&(null===e.psRatio||Number(e.psRatio)<Number(t.minPS))||null!==t.maxPS&&void 0!==t.maxPS&&(null===e.psRatio||Number(e.psRatio)>Number(t.maxPS))||null!==t.minPB&&void 0!==t.minPB&&(null===e.pbRatio||Number(e.pbRatio)<Number(t.minPB))||null!==t.maxPB&&void 0!==t.maxPB&&(null===e.pbRatio||Number(e.pbRatio)>Number(t.maxPB))||null!==t.minPCF&&void 0!==t.minPCF&&(null===e.pcfRatio||Number(e.pcfRatio)<Number(t.minPCF))||null!==t.maxPCF&&void 0!==t.maxPCF&&(null===e.pcfRatio||Number(e.pcfRatio)>Number(t.maxPCF))||null!==t.minROE&&void 0!==t.minROE&&(null===e.roe||Number(e.roe)<Number(t.minROE))||null!==t.maxROE&&void 0!==t.maxROE&&(null===e.roe||Number(e.roe)>Number(t.maxROE))||null!==t.minDebtToEquity&&void 0!==t.minDebtToEquity&&(null===e.debtToEquity||Number(e.debtToEquity)<Number(t.minDebtToEquity))||null!==t.maxDebtToEquity&&void 0!==t.maxDebtToEquity&&(null===e.debtToEquity||Number(e.debtToEquity)>Number(t.maxDebtToEquity))||null!==t.minCurrentRatio&&void 0!==t.minCurrentRatio&&(null===e.currentRatio||Number(e.currentRatio)<Number(t.minCurrentRatio))||null!==t.maxCurrentRatio&&void 0!==t.maxCurrentRatio&&(null===e.currentRatio||Number(e.currentRatio)>Number(t.maxCurrentRatio))||null!==t.minRevenueGrowth&&void 0!==t.minRevenueGrowth&&(null===e.revenueGrowth||Number(e.revenueGrowth)<Number(t.minRevenueGrowth))||null!==t.maxRevenueGrowth&&void 0!==t.maxRevenueGrowth&&(null===e.revenueGrowth||Number(e.revenueGrowth)>Number(t.maxRevenueGrowth))||null!==t.minEarningsGrowth&&void 0!==t.minEarningsGrowth&&(null===e.earningsGrowth||Number(e.earningsGrowth)<Number(t.minEarningsGrowth))||null!==t.maxEarningsGrowth&&void 0!==t.maxEarningsGrowth&&(null===e.earningsGrowth||Number(e.earningsGrowth)>Number(t.maxEarningsGrowth))||null!==t.minDividendYield&&void 0!==t.minDividendYield&&(null===e.dividendYield||Number(e.dividendYield)<Number(t.minDividendYield))||null!==t.maxDividendYield&&void 0!==t.maxDividendYield&&(null===e.dividendYield||Number(e.dividendYield)>Number(t.maxDividendYield))||null!==t.minMarketCap&&void 0!==t.minMarketCap&&(null===e.marketCap||Number(e.marketCap)<Number(t.minMarketCap))||null!==t.maxMarketCap&&void 0!==t.maxMarketCap&&(null===e.marketCap||Number(e.marketCap)>Number(t.maxMarketCap))||null!==t.minVolume&&void 0!==t.minVolume&&(null===e.volume||Number(e.volume)<Number(t.minVolume))||null!==t.maxVolume&&void 0!==t.maxVolume&&(null===e.volume||Number(e.volume)>Number(t.maxVolume))||null!==t.minMomentum&&void 0!==t.minMomentum&&(null===e.momentum||Number(e.momentum)<Number(t.minMomentum))||null!==t.maxMomentum&&void 0!==t.maxMomentum&&(null===e.momentum||Number(e.momentum)>Number(t.maxMomentum)))}async executeTrades(e,t){this.alpacaClient||await this.initializeAlpaca(e);let i=await r._.tradingAccount.findUnique({where:{userId:e}});if(!i||!i.automationEnabled)return console.log("Automated trading is disabled"),[];let n=await r._.position.count({where:{userId:e,status:"OPEN"}}),o=i.maxPositions-n;if(o<=0)return console.log("No available position slots"),[];let s=Number(i.currentValue)/i.maxPositions,l=[];for(let n=0;n<Math.min(t.length,o);n++){let o=t[n];try{let t;let n=await r._.watchlistItem.findUnique({where:{id:o.id},include:{screen:!0}}),c=await a.J.getQuote(o.ticker);if(!c?.c)continue;let u=c.c,m=n?.screen?.allocatedCapital?Number(n.screen.allocatedCapital):0;if(m>0&&n?.screen){let e=n.screen,r=Number(e.currentCapital||e.allocatedCapital),a=i.maxPositions,s=r/a;t=Math.floor(s/u),console.log(`[Capital Tracking] Screen ${e.name}: Using allocated capital $${r.toFixed(2)} for ${o.ticker}`)}else t=Math.floor(s/u);if(t<1)continue;let p=u*t;m>0&&n?.screenId&&await this.updateScreenCapital(n.screenId,-p,`BUY ${o.ticker} x${t} @ $${u.toFixed(2)}`);let g=await this.alpacaClient.createOrder({symbol:o.ticker,qty:t,side:"buy",type:"market",time_in_force:"day"});await this.alpacaClient.createOrder({symbol:o.ticker,qty:t,side:"sell",type:"trailing_stop",time_in_force:"gtc",trail_percent:Number(i.trailingStopPct)}),await r._.position.create({data:{userId:e,ticker:o.ticker,watchlistItemId:o.id,quantity:t,entryPrice:u,currentPrice:u,unrealizedPnl:0,trailingStopPrice:u*(1-Number(i.trailingStopPct)/100),alpacaOrderId:g.id,entryTime:new Date,status:"OPEN"}}),await r._.trade.create({data:{userId:e,ticker:o.ticker,watchlistItemId:o.id,quantity:t,entryPrice:u,entryTime:new Date,alpacaEntryOrderId:g.id,strategy:"O'Shaughnessy Auto"}}),l.push({ticker:o.ticker,quantity:t,entryPrice:u,orderId:g.id}),console.log(`Executed trade: ${o.ticker} x${t} @ $${u}`),await d.sendTradeNotification({userId:e,ticker:o.ticker,action:"BUY",quantity:t,price:u,reason:"New trading opportunity identified"}).catch(e=>console.error("Failed to send trade notification:",e))}catch(e){console.error(`Error executing trade for ${o.ticker}:`,e)}}return l}async monitorPositions(e){for(let t of(this.alpacaClient||await this.initializeAlpaca(e),await r._.position.findMany({where:{userId:e,status:"OPEN"}})))try{let e=await a.J.getQuote(t.ticker);if(!e?.c)continue;let i=e.c,n=(i-Number(t.entryPrice))*t.quantity;await r._.position.update({where:{id:t.id},data:{currentPrice:i,unrealizedPnl:n}});let o=await this.checkSellSignals(t,i);o.sell&&await this.sellPosition(t.id,o.reason||"MANUAL")}catch(e){console.error(`Error monitoring position ${t.ticker}:`,e)}}async checkSellSignals(e,t){let i=await r._.tradingAccount.findUnique({where:{userId:e.userId}});if(!i)return{sell:!1};let a=new Date,n=new Date;return(n.setHours(i.timeCutoffHour,i.timeCutoffMin,0,0),a>=n)?{sell:!0,reason:"TIME_CUTOFF"}:(await this.analyzeNews(e.ticker)).sentimentScore<-.5?{sell:!0,reason:"NEGATIVE_NEWS"}:{sell:!1}}async sellPosition(e,t){try{let i=await r._.position.findUnique({where:{id:e},include:{watchlistItem:{include:{screen:!0}}}});if(!i||"OPEN"!==i.status)return;this.alpacaClient||await this.initializeAlpaca(i.userId);let a=await this.alpacaClient.createOrder({symbol:i.ticker,qty:i.quantity,side:"sell",type:"market",time_in_force:"day"}),n=Number(i.currentPrice),o=(n-Number(i.entryPrice))*i.quantity,s=n*i.quantity;(i.watchlistItem?.screen?.allocatedCapital?Number(i.watchlistItem.screen.allocatedCapital):0)>0&&i.watchlistItem?.screenId&&await this.updateScreenCapital(i.watchlistItem.screenId,s,`SELL ${i.ticker} x${i.quantity} @ $${n.toFixed(2)} | P&L: $${o.toFixed(2)}`),await r._.position.update({where:{id:e},data:{status:"CLOSED"}});let l=await r._.trade.findFirst({where:{ticker:i.ticker,userId:i.userId,exitTime:null}});l&&await r._.trade.update({where:{id:l.id},data:{exitPrice:n,exitTime:new Date,realizedPnl:o,exitReason:t,alpacaExitOrderId:a.id,holdTimeMinutes:Math.floor((Date.now()-new Date(i.entryTime).getTime())/6e4)}}),console.log(`Sold position: ${i.ticker} @ $${n} (${t})`),await d.sendTradeNotification({userId:i.userId,ticker:i.ticker,action:"SELL",quantity:i.quantity,price:n,pnl:o,entryPrice:Number(i.entryPrice),reason:t}).catch(e=>console.error("Failed to send trade notification:",e))}catch(t){console.error(`Error selling position ${e}:`,t)}}async runBacktest(e){console.log("Starting backtest..."),console.log("Parameters:",e);let t=await r._.screen.findUnique({where:{id:e.screenId}});if(!t)throw Error("Screen not found");let i=new Date(e.startDate),a=new Date(e.endDate),n=e.initialCapital,o=e.initialCapital,s=new Map,l=[],d=[],c=0,u=0,m=0,p=0,g=e.initialCapital,h=0,y=new Date(i),f=0;for(;y<=a;){let i=y.getDay();if(0===i||6===i){y.setDate(y.getDate()+1);continue}let r=y.toISOString().split("T")[0];f++;let a=await this.getScreenedStocksForDate(t,r);for(let[t,i]of s.entries()){let o=a.find(e=>e.symbol===t);if(o){let a=Number(o.currentPrice);i.currentPrice=a,i.unrealizedPnl=(a-i.entryPrice)*i.quantity,i.daysHeld++,a>i.highWaterMark&&(i.highWaterMark=a,i.trailingStop=a*(1-e.trailingStopPct/100));let d=!1,g="";if(a<=i.trailingStop&&(d=!0,g="TRAILING_STOP"),-10>Number(o.momentum3M)&&(d=!0,g="NEGATIVE_MOMENTUM"),i.daysHeld>=5&&(d=!0,g="TIME_CUTOFF"),d){let e=(a-i.entryPrice)*i.quantity,o=(a-i.entryPrice)/i.entryPrice*100;l.push({ticker:i.ticker,entryDate:i.entryDate,exitDate:r,entryPrice:i.entryPrice,exitPrice:a,quantity:i.quantity,pnl:e,pnlPct:o,daysHeld:i.daysHeld,exitReason:g,result:e>0?"win":"loss"}),n+=i.entryPrice*i.quantity+e,e>0?(c++,m+=e):(u++,p+=Math.abs(e)),s.delete(t)}}}let x=0;for(let e of s.values())x+=e.currentPrice*e.quantity;(o=n+x)>g&&(g=o);let b=(g-o)/g*100;if(b>h&&(h=b),d.push({date:r,value:o,cash:n,positionsValue:x,openPositions:s.size}),s.size<e.maxPositions&&a.length>0)for(let t of a.filter(e=>Number(e.momentum3M)>5&&!s.has(e.symbol)).slice(0,e.maxPositions-s.size)){let i=Number(t.currentPrice),a=Math.floor(n/e.maxPositions/i);a>=1&&n>=i*a&&(n-=i*a,s.set(t.symbol,{ticker:t.symbol,entryDate:r,entryPrice:i,currentPrice:i,quantity:a,highWaterMark:i,trailingStop:i*(1-e.trailingStopPct/100),unrealizedPnl:0,daysHeld:0}))}y.setDate(y.getDate()+1)}for(let[e,t]of s.entries()){let e=t.currentPrice,i=(e-t.entryPrice)*t.quantity,r=(e-t.entryPrice)/t.entryPrice*100;l.push({ticker:t.ticker,entryDate:t.entryDate,exitDate:a.toISOString().split("T")[0],entryPrice:t.entryPrice,exitPrice:e,quantity:t.quantity,pnl:i,pnlPct:r,daysHeld:t.daysHeld,exitReason:"BACKTEST_END",result:i>0?"win":"loss"}),i>0?(c++,m+=i):(u++,p+=Math.abs(i))}let x=o-e.initialCapital,b=x/e.initialCapital*100,w=l.length,k=w>0?c/w*100:0,P=c>0?m/c/e.initialCapital*100:0,$=u>0?p/u/e.initialCapital*100:0,v=p>0?m/p:m>0?999:0,N=d.map((e,t)=>0===t?0:(e.value-d[t-1].value)/d[t-1].value),S=N.reduce((e,t)=>e+t,0)/N.length,E=Math.sqrt(N.reduce((e,t)=>e+Math.pow(t-S,2),0)/N.length),T=w>0?l.reduce((e,t)=>e+t.daysHeld,0)/w:0,C=l.length>0?Math.max(...l.map(e=>e.pnlPct)):0,D=l.length>0?Math.min(...l.map(e=>e.pnlPct)):0;return console.log(`Backtest complete: ${w} trades, ${b.toFixed(2)}% return`),{totalReturn:x,totalReturnPct:b,finalValue:o,winRate:k,totalTrades:w,winningTrades:c,losingTrades:u,avgGain:P,avgLoss:$,bestTrade:C,worstTrade:D,maxDrawdown:h,sharpeRatio:E>0?S/E*Math.sqrt(252):0,avgHoldTime:T,profitFactor:v,tradingDaysProcessed:f,trades:l.slice(-20).reverse(),dailyValues:d,parameters:e}}async getScreenedStocksForDate(e,t){let i={snapshotDate:new Date(t),hasError:!1,dataQuality:{gte:30}};return(e.minPE||e.maxPE||e.peRatioMax)&&(i.peRatio={gte:e.minPE?Number(e.minPE):void 0,lte:e.maxPE||e.peRatioMax?Number(e.maxPE||e.peRatioMax):void 0,not:null}),(e.minPS||e.maxPS||e.psRatioMax)&&(i.psRatio={gte:e.minPS?Number(e.minPS):void 0,lte:e.maxPS||e.psRatioMax?Number(e.maxPS||e.psRatioMax):void 0,not:null}),(e.minPB||e.maxPB)&&(i.pbRatio={gte:e.minPB?Number(e.minPB):void 0,lte:e.maxPB?Number(e.maxPB):void 0,not:null}),(e.minROE||e.maxROE)&&(i.roe={gte:e.minROE?Number(e.minROE):void 0,lte:e.maxROE?Number(e.maxROE):void 0,not:null}),(e.minDebtToEquity||e.maxDebtToEquity)&&(i.debtToEquity={gte:e.minDebtToEquity?Number(e.minDebtToEquity):void 0,lte:e.maxDebtToEquity?Number(e.maxDebtToEquity):void 0,not:null}),e.minMarketCap&&(i.marketCap={...i.marketCap,gte:1e6*Number(e.minMarketCap)}),e.minMomentum3M&&(i.momentum3M={gte:Number(e.minMomentum3M),not:null}),await r._.stockDataSnapshot.findMany({where:i,take:50,orderBy:[{momentum3M:"desc"}]})}async runPaperTradingBacktest(e){console.log(`Starting paper trading backtest for run ${e}...`);let t=await r._.paperTradingRun.findUnique({where:{id:e},include:{screen:!0}});if(!t)throw Error("Paper trading run not found");if(!t.screen)throw Error("Paper trading run must have a screen associated");let i=new Date(t.startDate),a=t.endDate?new Date(t.endDate):new Date,n=t.startingCapital.toNumber(),o=t.startingCapital.toNumber(),s=new Map,l=[],d=0,c=0,u=0,m=0,p=t.startingCapital.toNumber(),g=0,h=new Date(i);for(;h<=a;){let e=h.getDay();if(0===e||6===e){h.setDate(h.getDate()+1);continue}let i=h.toISOString().split("T")[0],r=await this.getScreenedStocksForDate(t.screen,i);for(let[e,a]of s.entries()){let o=r.find(t=>t.symbol===e);if(o){let r=Number(o.currentPrice);a.currentPrice=r,a.unrealizedPnl=(r-a.entryPrice)*a.quantity,a.daysHeld++,r>a.highWaterMark&&(a.highWaterMark=r,a.trailingStop=r*(1-t.trailingStopPct.toNumber()/100));let p=!1,g="STOP_LOSS";if(r<=a.trailingStop&&(p=!0,g="STOP_LOSS"),-10>Number(o.momentum3M)&&(p=!0,g="NEGATIVE_NEWS"),a.daysHeld>=5&&(p=!0,g="TIME_CUTOFF"),p){let t=(r-a.entryPrice)*a.quantity,o=1440*a.daysHeld;l.push({ticker:a.ticker,entryDate:a.entryDate,exitDate:i,entryPrice:a.entryPrice,exitPrice:r,quantity:a.quantity,pnl:t,holdTimeMinutes:o,exitReason:g}),n+=a.entryPrice*a.quantity+t,t>0?(d++,u+=t):(c++,m+=Math.abs(t)),s.delete(e)}}}let a=0;for(let e of s.values())a+=e.currentPrice*e.quantity;(o=n+a)>p&&(p=o);let y=(p-o)/p*100;if(y>g&&(g=y),s.size<t.maxPositions&&r.length>0)for(let e of r.filter(e=>Number(e.momentum3M)>5&&!s.has(e.symbol)).slice(0,t.maxPositions-s.size)){let r=Number(e.currentPrice),a=Math.floor(n/t.maxPositions/r);a>=1&&n>=r*a&&(n-=r*a,s.set(e.symbol,{ticker:e.symbol,entryDate:i,entryPrice:r,currentPrice:r,quantity:a,highWaterMark:r,trailingStop:r*(1-t.trailingStopPct.toNumber()/100),unrealizedPnl:0,daysHeld:0}))}h.setDate(h.getDate()+1)}for(let[e,t]of s.entries()){let e=t.currentPrice,i=(e-t.entryPrice)*t.quantity,r=1440*t.daysHeld;l.push({ticker:t.ticker,entryDate:t.entryDate,exitDate:a.toISOString().split("T")[0],entryPrice:t.entryPrice,exitPrice:e,quantity:t.quantity,pnl:i,holdTimeMinutes:r,exitReason:"TIME_CUTOFF"}),i>0?(d++,u+=i):(c++,m+=Math.abs(i))}let y=(o-t.startingCapital.toNumber())/t.startingCapital.toNumber()*100,f=o-t.startingCapital.toNumber(),x=l.length,b=x>0?d/x*100:0,w=m>0?u/m:u>0?999:0,k=d>0?u/d:0,P=c>0?m/c:0,$=x>0?l.reduce((e,t)=>e+t.holdTimeMinutes/1440,0)/x:0,v=l.map(e=>e.pnl/t.startingCapital.toNumber()*100),N=v.length>0?v.reduce((e,t)=>e+t,0)/v.length:0,S=v.length>0?Math.sqrt(v.reduce((e,t)=>e+Math.pow(t-N,2),0)/v.length):0;for(let i of l)await r._.trade.create({data:{userId:t.userId,ticker:i.ticker,paperTradingRunId:e,quantity:i.quantity,entryPrice:i.entryPrice,exitPrice:i.exitPrice,realizedPnl:i.pnl,entryTime:new Date(i.entryDate),exitTime:new Date(i.exitDate),holdTimeMinutes:i.holdTimeMinutes,exitReason:i.exitReason,strategy:t.screen?.name||"Unknown"}});await r._.paperTradingRun.update({where:{id:e},data:{status:"COMPLETED",finalCapital:o,totalReturn:y,totalReturnDollars:f,totalTrades:x,winningTrades:d,losingTrades:c,winRate:b,avgWinAmount:k,avgLossAmount:P,sharpeRatio:S>0?N/S:0,maxDrawdown:g,profitFactor:w,avgHoldTimeDays:$,completedAt:new Date}}),console.log(`Paper trading backtest complete for run ${e}: ${x} trades, ${y.toFixed(2)}% return`)}constructor(){this.alpacaClient=null}}let u=new c}};